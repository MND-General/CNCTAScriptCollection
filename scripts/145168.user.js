// ==UserScript==
// @name        Maelstrom ADDON Basescanner
// @namespace   http*://prodgame*.alliances.commandandconquer.com/*/index.aspx*
// @description Maelstrom ADDON Basescanner
// @include     http*://prodgame*.alliances.commandandconquer.com/*/index.aspx*
// @version     0.6
// @author      BlinDManX
// @grant       none
// ==/UserScript==
var __msbs_version=0.6;(function(){var c=function(){try{console.log("Maelstrom_Basescanner "+window.__msbs_version+" loaded");function h(){console.log("Maelstrom_Basescanner initalisiert");var m=null;var j=null;var k=null;var o=null;var n=0;var q=0;o=ClientLib.File.FileManager.GetInstance();m=window.MaelstromTools.Language.getInstance();j=window.MaelstromTools.Cache.getInstance();k=window.MaelstromTools.Base.getInstance();var e=m.Languages.indexOf(qx.locale.Manager.getInstance().getLocale());if(e>=0){m.Data["Point"]=["Position","Position","Position"][e];m.Data["BaseScanner Overview"]=["Basescanner Übersicht","Visão geral do scanner de base","Aperçu du scanner de base"][e];m.Data["Scan"]=["Scannen","Esquadrinhar","Balayer"][e];m.Data["Location"]=["Lage","localização","Emplacement"][e];m.Data["Player"]=["Spieler","Jogador","Joueur"][e];m.Data["Bases"]=["Basen","Bases","Bases"][e];m.Data["Camp,Outpost"]=["Lager,Vorposten","Camp,posto avançado","Camp,avant-poste"][e];m.Data["BaseScanner Layout"]=["BaseScanner Layout","Layout da Base de Dados de Scanner","Mise scanner de base"][e];m.Data["Show Layouts"]=["Layouts anzeigen","Mostrar Layouts","Voir Layouts"][e];m.Data["Building state"]=["Gebäudezustand","construção do Estado","construction de l'État"][e];m.Data["Defense state"]=["Verteidigungszustand","de Defesa do Estado","défense de l'Etat"][e];m.Data["CP"]=["KP","CP","CP"][e];m.Data["CP Limit"]=["KP begrenzen","CP limitar","CP limiter"][e]}k.createNewImage("BaseScanner","ui/icons/icon_item.png",o);k.createNewImage("Emptypixels","ui/menues/main_menu/misc_empty_pixel.png",o);k.createNewWindow("BaseScanner","L",120,60,820,400);k.createNewWindow("BaseScannerLayout","L",120,460,820,350);var p=k.createDesktopButton(m.gt("BaseScanner Overview"),"BaseScanner",false,k.desktopPosition(2));p.addListener("execute",function(){if(window.HuffyTools.BaseScannerGUI.getInstance().Window!=null){}window.HuffyTools.BaseScannerGUI.getInstance().openWindow("BaseScanner",m.gt("BaseScanner Overview"))},this);k.addToMainMenu("BaseScanner",p);qx.Class.define("HuffyTools.BaseScannerGUI",{type:"singleton",extend:MaelstromTools.DefaultObject,members:{HT_Tables:null,HT_Models:null,HT_Options:null,upgradeInProgress:null,scanButton:null,runloop:null,CitySelect:null,HT_ShowBase:null,resmap:null,resmapViewOptions:null,resmapViewButton:null,rowData:null,cplimiter:null,buildingsConditioncount:0,init:function(){try{this.upgradeInProgress=false;this.createTable();this.createOptions();if(this.rowData==null){this.rowData=[]}this.Window.setPadding(0);this.Window.set({resizable:true});this.Window.removeAll();this.Window.add(this.HT_Options);this.Window.add(this.HT_Tables);this.Window.addListener("close",window.HuffyTools.BaseScannerGUI.getInstance().closeCallback);var l=document.createElement("img");l.src="http://goo.gl/RTscG"}catch(r){console.log("HuffyTools.BaseScannerGUI.init: ",r)}},createTable:function(){try{this.HT_Models=new qx.ui.table.model.Simple();this.HT_Models.setColumns(["ID","LoadState",m.gt("City"),m.gt("Location"),m.gt("Level"),m.gt(MaelstromTools.Statics.Tiberium),m.gt(MaelstromTools.Statics.Crystal),m.gt(MaelstromTools.Statics.Dollar),m.gt(MaelstromTools.Statics.Research),"","",m.gt("Building state"),m.gt("Defense state"),m.gt("CP"),"Def.HP/Off.HP"]);this.HT_Tables=new qx.ui.table.Table(this.HT_Models);this.HT_Tables.setColumnVisibilityButtonVisible(true);this.HT_Tables.setColumnWidth(0,0);this.HT_Tables.setColumnWidth(1,0);this.HT_Tables.setColumnWidth(2,120);this.HT_Tables.setColumnWidth(3,60);this.HT_Tables.setColumnWidth(4,50);this.HT_Tables.setColumnWidth(5,60);this.HT_Tables.setColumnWidth(6,60);this.HT_Tables.setColumnWidth(7,60);this.HT_Tables.setColumnWidth(8,60);this.HT_Tables.setColumnWidth(9,30);this.HT_Tables.setColumnWidth(10,30);this.HT_Tables.setColumnWidth(11,50);this.HT_Tables.setColumnWidth(12,50);this.HT_Tables.setColumnWidth(13,50);this.HT_Tables.setColumnWidth(14,90);var r=this.HT_Tables.getTableColumnModel();r.setColumnVisible(0,false);r.setColumnVisible(1,false);r.setHeaderCellRenderer(9,new qx.ui.table.headerrenderer.Icon(k.images[MaelstromTools.Statics.Crystal]));r.setHeaderCellRenderer(10,new qx.ui.table.headerrenderer.Icon(k.images[MaelstromTools.Statics.Tiberium]));r.setDataCellRenderer(5,new HuffyTools.ReplaceRender().set({ReplaceFunction:this.formatTiberiumAndPower}));r.setDataCellRenderer(6,new HuffyTools.ReplaceRender().set({ReplaceFunction:this.formatTiberiumAndPower}));r.setDataCellRenderer(7,new HuffyTools.ReplaceRender().set({ReplaceFunction:this.formatTiberiumAndPower}));r.setDataCellRenderer(8,new HuffyTools.ReplaceRender().set({ReplaceFunction:this.formatTiberiumAndPower}));this.HT_Tables.addListener("cellDblclick",function(s){window.HuffyTools.BaseScannerGUI.getInstance().cellDoubleClickCallback(s)},this)}catch(l){console.log("HuffyTools.BaseScannerGUI.createTable: ",l)}},cellDoubleClickCallback:function(s){try{var w=this.rowData[s.getRow()][0];var v=this.rowData[s.getRow()][3];if(v!=null&&v.split(":").length==2){var u=parseInt(v.split(":")[0]);var t=parseInt(v.split(":")[1]);ClientLib.Vis.VisMain.GetInstance().CenterGridPosition(u,t)}if(w){var l=qx.core.Init.getApplication();l.getBackgroundArea().closeCityInfo();l.getPlayArea().setView(webfrontend.gui.PlayArea.PlayArea.modes.EMode_CombatSetupDefense,w,0,0)}}catch(r){console.log("HuffyTools.BaseScannerGUI cellDoubleClickCallback error: ",r)}},closeCallback:function(l){this.runloop=false},CBChanged:function(l){this.upgradeInProgress=false;this.runloop=false},formatTiberiumAndPower:function(l){return webfrontend.gui.Util.formatNumbersCompact(l)},updateCache:function(){try{}catch(l){console.log("HuffyTools.BaseScannerGUI.updateCache: ",l)}},setWidgetLabels:function(){try{if(!this.HT_Models){this.init()}this.HT_Models.setData(this.rowData)}catch(l){console.log("HuffyTools.BaseScannerGUI.setWidgetLabels: ",l)}},createOptions:function(){var v=new qx.ui.layout.Flow();var t=new qx.ui.container.Composite(v);this.CitySelect=new qx.ui.form.SelectBox();this.CitySelect.setHeight(25);this.CitySelect.setMargin(5);j.updateCityCache();j=window.MaelstromTools.Cache.getInstance();for(var s in j.Cities){var u=new qx.ui.form.ListItem(s,null,j.Cities[s].Object);this.CitySelect.add(u);if(MaelstromTools.LocalStorage.get("MS_Basescanner_LastCityID")==j.Cities[s].Object.get_Id()){this.CitySelect.setSelection([u])}}t.add(this.CitySelect);var r=new qx.ui.basic.Label().set({value:m.gt("CP Limit"),textColor:"white",margin:5});t.add(r);this.cplimiter=new qx.ui.form.SelectBox();this.cplimiter.setWidth(50);this.cplimiter.setHeight(25);this.cplimiter.setMargin(5);for(r=10;r<46;r+=5){u=new qx.ui.form.ListItem(""+r,null,r);this.cplimiter.add(u);if(MaelstromTools.LocalStorage.get("MS_Basescanner_Cplimiter")==r){this.cplimiter.setSelection([u])}}t.add(this.cplimiter);this.HT_ShowBase=[];this.HT_ShowBase[0]=new qx.ui.form.CheckBox(m.gt("Player"));this.HT_ShowBase[0].setMargin(5);this.HT_ShowBase[0].setTextColor("white");this.HT_ShowBase[0].setValue(MaelstromTools.LocalStorage.get("MS_Basescanner_Show0",false));t.add(this.HT_ShowBase[0]);this.HT_ShowBase[1]=new qx.ui.form.CheckBox(m.gt("Bases"));this.HT_ShowBase[1].setMargin(5);this.HT_ShowBase[1].setTextColor("white");this.HT_ShowBase[1].setValue(MaelstromTools.LocalStorage.get("MS_Basescanner_Show1",false));t.add(this.HT_ShowBase[1]);this.HT_ShowBase[2]=new qx.ui.form.CheckBox(m.gt("Camp,Outpost"));this.HT_ShowBase[2].setMargin(5);this.HT_ShowBase[2].setTextColor("white");this.HT_ShowBase[2].setValue(MaelstromTools.LocalStorage.get("MS_Basescanner_Show2",true));t.add(this.HT_ShowBase[2]);this.scanButton=new qx.ui.form.Button(m.gt("Scan")).set({width:100,minWidth:100,maxWidth:100,height:25,margin:5});this.scanButton.addListener("execute",function(){this.scan()},this);t.add(this.scanButton,{lineBreak:true});this.resmapViewOptions=new qx.ui.form.SelectBox();this.resmapViewOptions.setWidth(150);this.resmapViewOptions.setHeight(25);this.resmapViewOptions.setMargin(5);var u=new qx.ui.form.ListItem("7 "+m.gt(MaelstromTools.Statics.Tiberium)+" 5 "+m.gt(MaelstromTools.Statics.Crystal),null,7);this.resmapViewOptions.add(u);u=new qx.ui.form.ListItem("6 "+m.gt(MaelstromTools.Statics.Tiberium)+" 6 "+m.gt(MaelstromTools.Statics.Crystal),null,6);this.resmapViewOptions.add(u);u=new qx.ui.form.ListItem("5 "+m.gt(MaelstromTools.Statics.Tiberium)+" 7 "+m.gt(MaelstromTools.Statics.Crystal),null,5);this.resmapViewOptions.add(u);t.add(this.resmapViewOptions);this.resmapViewButton=new qx.ui.form.Button(m.gt("Get Layouts")).set({width:120,minWidth:120,maxWidth:120,height:25,margin:5});this.resmapViewButton.addListener("execute",function(){var l=window.HuffyTools.BaseScannerLayout.getInstance();if(l.Window!=null){l.Window.close();l.createmap()}l.openWindow("BaseScannerLayout",m.gt("BaseScanner Layout"))},this);this.resmapViewButton.setEnabled(false);t.add(this.resmapViewButton);this.HT_Options=t},scan:function(){try{this.upgradeInProgress=true;this.rowData=[];var u=this.CitySelect.getSelection()[0].getModel();MaelstromTools.LocalStorage.set("MS_Basescanner_LastCityID",u.get_Id());var I=this.cplimiter.getSelection()[0].getModel();MaelstromTools.LocalStorage.set("MS_Basescanner_Cplimiter",I);var D=this.HT_ShowBase[0].getValue();var B=this.HT_ShowBase[1].getValue();var A=this.HT_ShowBase[2].getValue();console.log("Select",D,B,A);MaelstromTools.LocalStorage.set("MS_Basescanner_Show0",D);MaelstromTools.LocalStorage.set("MS_Basescanner_Show1",B);MaelstromTools.LocalStorage.set("MS_Basescanner_Show2",A);var s=u.get_PosX();var r=u.get_PosY();var H=0;var G=0;var C=ClientLib.Data.MainData.GetInstance().get_World();console.log("Scanning from: "+u.get_Name());ClientLib.Vis.VisMain.GetInstance().CenterGridPosition(s,r);ClientLib.Data.MainData.GetInstance().get_Cities().set_CurrentCityId(u.get_Id());var t=ClientLib.Data.MainData.GetInstance().get_Server().get_MaxAttackDistance();for(G=r-Math.floor(t+1);G<=r+Math.floor(t+1);G++){for(H=s-Math.floor(t+1);H<=s+Math.floor(t+1);H++){var z=Math.abs(s-H);var w=Math.abs(r-G);var l=Math.sqrt((z*z)+(w*w));if(l<=t){var J=C.GetObjectFromPosition(H,G);var E={};if(J){if(J.ConditionBuildings>0){var v=u.CalculateAttackCommandPointCostToCoord(H,G);if(v<=I){if(J.ConditionBuildings!=100||J.ConditionDefense!=100){}if(J.Type==1&&D){this.rowData.push([J.Id,-1,J.Name,H+":"+G,J.Level,0,0,0,0,0,0,J.ConditionBuildings,J.ConditionDefense,v])}if(J.Type==2&&B){this.rowData.push([J.KOBHAO,-1,"Basis",H+":"+G,J.UPWSFR,0,0,0,0,0,0,J.ConditionBuildings,J.ConditionDefense,v])}if(J.Type==3&&A){this.rowData.push([J.QRDMVJ,-1,"Lager/Vorposten",H+":"+G,J.DDTOJV,0,0,0,0,0,0,J.ConditionBuildings,J.ConditionDefense,v])}}}}}}}this.runloop=true;this.resmap={};window.setTimeout("window.HuffyTools.BaseScannerGUI.getInstance().getResourcesByID()",50)}catch(F){console.log("Maelstrom_Basescanner scan error: ",F)}},getResourcesByID:function(){try{var R=false;var z=0;var H=10;var Q=0;var r=150;while(!R){var L=null;var v=0;var M=0;if(this.rowData==null){console.log("rowData null: ");this.runloop=false;break}for(Q=0;Q<this.rowData.length;Q++){if(this.rowData[Q][1]==-1){break}}if(Q==this.rowData.length){this.runloop=false}if(this.rowData[Q]==null){console.log("rowData[i] null: ");this.runloop=false;this.resmapViewButton.setEnabled(true);break}posData=this.rowData[Q][3];if(posData!=null&&posData.split(":").length==2){posX=parseInt(posData.split(":")[0]);posY=parseInt(posData.split(":")[1]);M=this.rowData[Q][0];webfrontend.gui.UtilView.openVisModeInMainWindow(1,M,false);L=window.MaelstromTools.Wrapper.GetCity(M);console.log("ncity",L);if(L!=null){var B=L.get_CityBuildingsData();var F=L.get_CityUnitsData();if(B!=null){var C=window.MaelstromTools.Wrapper.GetBuildings(B);var A=window.MaelstromTools.Wrapper.GetDefenseUnits(F);if(C!=null){var G=window.MaelstromTools.Util.getResourcesPart(C);var D=window.MaelstromTools.Util.getResourcesPart(A);this.rowData[Q][2]=L.get_Name();this.rowData[Q][5]=G[ClientLib.Base.EResourceType.Tiberium]+D[ClientLib.Base.EResourceType.Tiberium];this.rowData[Q][6]=G[ClientLib.Base.EResourceType.Crystal]+D[ClientLib.Base.EResourceType.Crystal];this.rowData[Q][7]=G[ClientLib.Base.EResourceType.Gold]+D[ClientLib.Base.EResourceType.Gold];this.rowData[Q][8]=G[ClientLib.Base.EResourceType.ResearchPoints]+D[ClientLib.Base.EResourceType.ResearchPoints];if(L.GetBuildingsConditionInPercent()!=0){this.buildingsConditioncount=0;if(this.rowData[Q][5]!=0){var U=0;var K=0;this.resmap[M]=new Array(9);for(var N=0;N<9;N++){this.resmap[M][N]=new Array(8)}for(var P=0;P<9;P++){for(var O=0;O<8;O++){switch(L.GetResourceType(P,O)){case 1:this.resmap[M][P][O]=1;U++;break;case 2:this.resmap[M][P][O]=2;K++;break;default:break}}}this.rowData[Q][9]=U;this.rowData[Q][10]=K;this.rowData[Q][11]=L.GetBuildingsConditionInPercent();this.rowData[Q][12]=L.GetDefenseConditionInPercent();try{var E=this.CitySelect.getSelection()[0].getModel();var J=E.get_CityUnitsData().get_OffenseUnits().l;console.log("OffenseUnits",J);var s=0;var w=0;for(var S=0;S<J.length;S++){s+=J[S].get_Health()}J=L.get_CityUnitsData().get_DefenseUnits().l;console.log("DefUnits",J);for(S=0;S<J.length;S++){w+=J[S].get_Health()}console.log("HPs",s,w,(w/s))}catch(I){console.log("HPRecord",I)}this.rowData[Q][14]=(w/s);this.rowData[Q][1]=0;R=true;console.log(L.get_Name()," finish")}}else{if(this.buildingsConditioncount>10){console.log(this.rowData[Q][2]," on ",posX,posY," removed (GetBuildingsConditionInPercent == 0)");this.rowData.splice(Q,1);break}this.buildingsConditioncount++}}}}}z++;if(z>=H){R=true;break}}if(this.lastid!=Q){this.lastid=Q;this.countlastidchecked=0}else{this.countlastidchecked++;if(this.countlastidchecked>5){r=250}else{if(this.countlastidchecked>12){r=500}else{if(this.countlastidchecked>18){console.log(this.rowData[Q][2]," on ",posX,posY," removed (found no data)");this.rowData.splice(Q,1)}}}}if(this.runloop&&window.HuffyTools.BaseScannerGUI.getInstance().Window.isVisible()){window.setTimeout("window.HuffyTools.BaseScannerGUI.getInstance().getResourcesByID()",r)}}catch(T){console.log("MaelstromTools_Basescanner getResources",T)}}}});qx.Class.define("HuffyTools.BaseScannerLayout",{type:"singleton",extend:MaelstromTools.DefaultObject,members:{labels:null,scrollpane:null,comp:null,idcache:null,init:function(){try{console.log("BaseScannerLayout.init: ");this.labels=[];this.Window.setPadding(0);this.Window.set({resizable:false});this.Window.removeAll();this.Window.setLayout(new qx.ui.layout.Flow().set({spacingX:3,spacingY:3}));this.scrollpane=new qx.ui.container.Scroll().set({width:800,height:350});this.comp=new qx.ui.container.Composite();this.comp.setLayout(new qx.ui.layout.Flow().set({spacingX:3,spacingY:3}));this.Window.add(this.scrollpane);this.scrollpane.add(this.comp);this.createmap()}catch(l){console.log("HuffyTools.BaseScannerLayout.init: ",l)}},updateCache:function(){try{}catch(l){console.log("HuffyTools.BaseScannerLayout.updateCache: ",l)}},setWidgetLabels:function(){try{if(this.labels==null){this.init()}}catch(l){console.log("HuffyTools.BaseScannerLayout.setWidgetLabels: ",l)}},createmap:function(){var t=window.HuffyTools.BaseScannerGUI.getInstance().resmap;var v=window.HuffyTools.BaseScannerGUI.getInstance().rowData;this.idcache=[];var A=window.HuffyTools.BaseScannerGUI.getInstance().resmapViewOptions.getSelection()[0].getModel();var s=null;if(v==null){console.log("rowData null: ");return}this.labels=[];for(var r in t){for(i=0;i<v.length;i++){if(v[i][0]==r){s=v[i]}}if(s==null){continue}if(A>4&&A<8){if(A!=s[10]){continue}}else{continue}posData=s[3];if(posData!=null&&posData.split(":").length==2){posX=parseInt(posData.split(":")[0]);posY=parseInt(posData.split(":")[1])}var C='<table border="2" cellspacing="0" cellpadding="0">';var B=s[2]+" - "+s[3];C=C+'<tr><td colspan="9"><font color="#FFF">'+B+"</font></td></tr>";for(y=0;y<8;y++){C=C+"<tr>";for(x=0;x<9;x++){var w="";var z=t[r][x][y];switch(z==undefined?0:z){case 2:w='<img width="14" height="14" src="'+k.images[MaelstromTools.Statics.Tiberium]+'">';break;case 1:w='<img width="14" height="14" src="'+k.images[MaelstromTools.Statics.Crystal]+'">';break;default:w='<img width="14" height="14" src="'+k.images["Emptypixels"]+'">';break}C=C+"<td>"+w+"</td>"}C=C+"</tr>"}C=C+"</table>";var u=new qx.ui.basic.Label().set({backgroundColor:"#303030",value:C,rich:true});u.cid=r;this.idcache.push(r);u.addListener("click",function(D){console.log("clickid ",this.cid);var l=qx.core.Init.getApplication();l.getBackgroundArea().closeCityInfo();l.getPlayArea().setView(webfrontend.gui.PlayArea.PlayArea.modes.EMode_CombatSetupBase,this.cid,0,0)});u.setReturnValue=r;this.labels.push(u);this.comp.removeAll();for(a=0;a<this.labels.length;a++){this.comp.add(this.labels[a])}}},}})}function g(){try{if(typeof qx!="undefined"&&typeof MaelstromTools!="undefined"){h()}else{window.setTimeout(g,1000)}}catch(j){console.log("MaelstromTools_Basescanner_checkIfLoaded: ",j)}}if(/commandandconquer\.com/i.test(document.domain)){window.setTimeout(g,1000)}}catch(f){console.log("Maelstrom_Basescanner ERROR A: ",f)}};try{var b=document.createElement("script");b.innerHTML="("+c.toString()+")();";b.type="text/javascript";if(/commandandconquer\.com/i.test(document.domain)){document.getElementsByTagName("head")[0].appendChild(b)}}catch(d){console.log("MaelstromTools_Basescanner: init error: ",d)}})();
